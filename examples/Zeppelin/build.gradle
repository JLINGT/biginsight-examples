plugins {
  id 'org.hidetake.ssh' version '1.5.0'
}

// load some common helper methods
apply from: "${projectDir}/../../shared/common-helpers.gradle"

// get the cluster connection details
Properties props = new Properties()
props.load(new FileInputStream("$projectDir/../../connection.properties"))

task Install << {

    // ssh plugin documentation: https://gradle-ssh-plugin.github.io/docs/
    
    ssh.run {
        // remotes.bicluster is defined in shared/common-helpers.gradle
        session(remotes.bicluster) {

            try {
                // initialise kerberos
                execute "kinit -k -t ${props.username}.keytab ${props.username}@IBM.COM"
            } 
            catch (Exception e) {
                println "problem running kinit - maybe this is a Basic cluster?"
            }

            put from: "${projectDir}/zeppelin_install.sh", 
                into: "./zeppelin_install.sh"

            execute "bash ./zeppelin_install.sh"
        }
    }
}

task Run {
	dependsOn ZeppelinInstall
    def port = 1212 // TODO check this is available
    // TODO ssh port forwarding, e.g.
    // ssh -L 1212:localhost:8080 snowch@bi-hadoop-prod-4005.bi.services.us-south.bluemix.net
    print "Open a browser with URL: http://localhost:${port}"
}
